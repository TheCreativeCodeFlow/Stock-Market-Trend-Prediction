(()=>{"use strict";const t={apiEndpoint:"http://localhost:8000",geminiApiKey:"",autoAnalyze:!0,overlayEnabled:!0,showConfidence:!0,showExplanation:!0,analysisInterval:60};class e{constructor(t){this.connected=!1,this.demoMode=!0,this.baseUrl=t.replace(/\/$/,""),this.checkConnection()}isConnected(){return this.connected||this.demoMode}isDemoMode(){return this.demoMode&&!this.connected}async checkConnection(){try{const t=await fetch(`${this.baseUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"}});this.connected=t.ok,this.connected&&(this.demoMode=!1)}catch{this.connected=!1,this.demoMode=!0}}async analyze(t,e){try{const n={...t,gemini_api_key:e||void 0},i=await fetch(`${this.baseUrl}/api/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(i.ok)return this.connected=!0,this.demoMode=!1,await i.json()}catch{}return this.connected=!1,this.demoMode=!0,this.generateDemoPrediction(t)}generateDemoPrediction(t){const e=t.candles;let n,i,s=0,o=0,a=0;if(e.length>=2){for(const t of e.slice(-10))t.close>t.open?s++:o++;const t=e[Math.max(0,e.length-10)].close;a=(e[e.length-1].close-t)/t}a>.02&&s>o?(n="bullish",i=Math.min(70+3*s,85)):a<-.02&&o>s?(n="bearish",i=Math.min(70+3*o,85)):(n="neutral",i=50);const c=s+o+2,r=Math.round((s+1)/c*100),h=Math.round((o+1)/c*100),l=100-r-h,d=this.generateExplanation(n,i,s,o,a);return{prediction:{direction:n,confidence:i,probabilities:{bullish:r,bearish:h,neutral:Math.max(l,5)},timestamp:Date.now()},technicalAnalysis:{rsi:50+500*a},explanation:d,riskLevel:i>70?"low":i>50?"medium":"high",warnings:this.demoMode?["Demo mode - Backend server not connected"]:[],generatedAt:Date.now()}}generateExplanation(t,e,n,i,s){const o=s>0?"positive":s<0?"negative":"neutral",a=n>i?"bullish candles dominating":i>n?"bearish candles dominating":"mixed signals";return"bullish"===t?`Recent price action shows ${a} with ${o} momentum. The upward trend suggests potential continuation. Confidence at ${e}%.`:"bearish"===t?`Chart displays ${a} with ${o} momentum. Downward pressure indicates possible continuation. Confidence at ${e}%.`:`Market shows consolidation with ${a}. No clear directional bias detected. Consider waiting for clearer signals.`}async getNews(t){try{const e=await fetch(`${this.baseUrl}/api/news/${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(e.ok)return e.json()}catch{}return{headlines:[`${t} market analysis in progress`],sentiment:0}}}new class{constructor(){this.settings=t,this.lastInsight=null,this.apiClient=new e(this.settings.apiEndpoint),this.init()}async init(){const n=await chrome.storage.local.get("settings");n.settings&&(this.settings={...t,...n.settings},this.apiClient=new e(this.settings.apiEndpoint)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),console.log("[AI Trading Co-Pilot] Background service initialized")}handleMessage(t,e,n){switch(console.log("[AI Trading Co-Pilot] Background received message:",t.type),t.type){case"ANALYZE_CHART":return this.analyzeChart(t.payload).then(t=>{console.log("[AI Trading Co-Pilot] Analysis complete:",t),n(t)}).catch(t=>{console.error("[AI Trading Co-Pilot] Analysis error:",t),n({error:t.message})}),!0;case"GET_STATUS":const e={connected:this.apiClient.isConnected(),demoMode:this.apiClient.isDemoMode(),lastInsight:this.lastInsight,settings:this.settings};return console.log("[AI Trading Co-Pilot] Status request:",e),n(e),!1;case"SETTINGS_UPDATE":return this.updateSettings(t.payload),n({success:!0}),!1;default:return!1}}async analyzeChart(t){console.log("[AI Trading Co-Pilot] Analyzing chart:",t.symbol);try{const e=await this.apiClient.analyze(t,this.settings.geminiApiKey);return this.lastInsight=e,this.broadcastToContentScripts({type:"PREDICTION_RESULT",payload:e,timestamp:Date.now()}),e}catch(t){throw console.error("[AI Trading Co-Pilot] Analysis failed:",t),t}}async broadcastToContentScripts(t){const e=await chrome.tabs.query({url:"*://*.tradingview.com/*"});for(const n of e)n.id&&chrome.tabs.sendMessage(n.id,t).catch(()=>{})}async updateSettings(t){this.settings={...this.settings,...t},await chrome.storage.local.set({settings:this.settings}),t.apiEndpoint&&(this.apiClient=new e(this.settings.apiEndpoint))}}})();