(()=>{"use strict";const t={apiEndpoint:"http://localhost:8000",autoAnalyze:!0,overlayEnabled:!0,showConfidence:!0,showExplanation:!0,analysisInterval:60};class s{constructor(t){this.connected=!1,this.baseUrl=t.replace(/\/$/,""),this.checkConnection()}isConnected(){return this.connected}async checkConnection(){try{const t=await fetch(`${this.baseUrl}/health`,{method:"GET",headers:{"Content-Type":"application/json"}});this.connected=t.ok}catch{this.connected=!1}}async analyze(t){const s=await fetch(`${this.baseUrl}/api/analyze`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){const t=await s.json().catch(()=>({message:"Unknown error"}));throw new Error(t.message||`API error: ${s.status}`)}const e=await s.json();return this.connected=!0,e}async getNews(t){const s=await fetch(`${this.baseUrl}/api/news/${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`News API error: ${s.status}`);return s.json()}}new class{constructor(){this.settings=t,this.lastInsight=null,this.apiClient=new s(this.settings.apiEndpoint),this.init()}async init(){const e=await chrome.storage.local.get("settings");e.settings&&(this.settings={...t,...e.settings},this.apiClient=new s(this.settings.apiEndpoint)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),console.log("[AI Trading Co-Pilot] Background service initialized")}handleMessage(t,s,e){switch(t.type){case"ANALYZE_CHART":return this.analyzeChart(t.payload).then(e).catch(t=>e({error:t.message})),!0;case"GET_STATUS":return e({connected:this.apiClient.isConnected(),lastInsight:this.lastInsight,settings:this.settings}),!1;case"SETTINGS_UPDATE":return this.updateSettings(t.payload),e({success:!0}),!1;default:return!1}}async analyzeChart(t){try{const s=await this.apiClient.analyze(t);return this.lastInsight=s,this.broadcastToContentScripts({type:"PREDICTION_RESULT",payload:s,timestamp:Date.now()}),s}catch(t){throw console.error("[AI Trading Co-Pilot] Analysis failed:",t),t}}async broadcastToContentScripts(t){const s=await chrome.tabs.query({url:"*://*.tradingview.com/*"});for(const e of s)e.id&&chrome.tabs.sendMessage(e.id,t).catch(()=>{})}async updateSettings(t){this.settings={...this.settings,...t},await chrome.storage.local.set({settings:this.settings}),t.apiEndpoint&&(this.apiClient=new s(this.settings.apiEndpoint))}}})();