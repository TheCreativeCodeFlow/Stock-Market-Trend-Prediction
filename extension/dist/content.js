(()=>{"use strict";class t{constructor(){this.chartContainer=null}async analyzeChart(){return this.chartContainer=this.findChartContainer(),this.chartContainer?{symbol:this.inferSymbol(),timeframe:this.inferTimeframe(),candles:await this.analyzeCandles(),indicators:await this.analyzeIndicators()}:(console.warn("[ScreenAnalyzer] Chart container not found"),this.emptyChartData())}findChartContainer(){const t=[".chart-container canvas",'[class*="chart-markup-table"] canvas',".tv-chart-container canvas",'canvas[class*="chart"]'];for(const n of t){const t=document.querySelector(n);if(t)return t.closest(".chart-container")||t.parentElement}return null}inferSymbol(){const t=document.querySelectorAll('[class*="symbol"], [class*="ticker"]');for(const n of t){const t=n.textContent?.trim();if(t&&/^[A-Z0-9]{1,10}$/i.test(t))return t.toUpperCase()}return""}inferTimeframe(){return""}async analyzeCandles(){const t=[];if(!this.chartContainer)return t;const n=this.chartContainer.querySelector("canvas");if(!n)return t;const e=this.detectCandlesFromCanvas(n),a=this.detectPriceScale();if(a&&e.length>0)for(const r of e)t.push(this.visualToCandle(r,a,n.height));return t}detectCandlesFromCanvas(t){const n=[];try{const e=t.getContext("2d",{willReadFrequently:!0});if(!e)return n;const a=e.getImageData(0,0,t.width,t.height).data,r=Math.max(3,Math.floor(t.width/100));for(let e=0;e<t.width;e+=r){const i=this.analyzeVerticalStripe(a,e,t.width,t.height);i&&n.push({...i,x:e,width:r})}}catch(t){console.warn("[ScreenAnalyzer] Canvas analysis failed:",t)}return n}analyzeVerticalStripe(t,n,e,a){let r=-1,i=-1,s=0,o=0;for(let l=0;l<a;l++){const a=4*(l*e+n),c=t[a],d=t[a+1],h=t[a+2];if(t[a+3]<128)continue;const p=d>c&&d>h&&d>100,u=c>d&&c>h&&c>100;(p||u)&&(-1===r&&(r=l),i=l,p&&s++,u&&o++)}if(-1===r||i===r)return null;const l=s>o;return{top:r,bottom:i,bodyTop:r+Math.floor(.1*(i-r)),bodyBottom:i-Math.floor(.1*(i-r)),isBullish:l}}detectPriceScale(){const t=document.querySelectorAll('[class*="price-axis"] [class*="label"], [class*="priceAxis"] span'),n=[];return t.forEach(t=>{const e=t.textContent?.trim();if(e){const t=parseFloat(e.replace(/[^0-9.]/g,""));!isNaN(t)&&t>0&&n.push(t)}}),n.length>=2?{min:Math.min(...n),max:Math.max(...n)}:null}visualToCandle(t,n,e){const a=n.max-n.min,r=t=>{const r=1-t/e;return n.min+r*a},i=r(t.top),s=r(t.bottom),o=r(t.bodyTop),l=r(t.bodyBottom);return{timestamp:Date.now()-6e4*t.x,open:t.isBullish?l:o,high:i,low:s,close:t.isBullish?o:l,volume:0}}async analyzeIndicators(){return[]}emptyChartData(){return{symbol:"",timeframe:"",candles:[],indicators:[]}}}class n{parseChart(){return{symbol:this.extractSymbol(),timeframe:this.extractTimeframe(),candles:this.extractCandles(),indicators:this.extractIndicators()}}extractSymbol(){const t=["[data-symbol-full]",".tv-symbol-header__text",'[class*="symbolTitle"]',".chart-widget__symbol","title"];for(const n of t){const t=document.querySelector(n);if(t){const n=t.getAttribute("data-symbol-full")||t.textContent?.split(" ")[0]?.trim();if(n&&n.length>0&&n.length<20)return n.replace(/[^A-Z0-9:]/gi,"")}}const n=document.title.match(/^([A-Z0-9]+)/);return n?n[1]:"UNKNOWN"}extractTimeframe(){const t=['[data-name="intervals-tab"] .selected',".chart-toolbar-resolution button.isActive",'[class*="resolution"] [class*="active"]',"[data-resolution].active"];for(const n of t){const t=document.querySelector(n);if(t?.textContent)return t.textContent.trim()}return"1D"}extractCandles(){const t=this.extractFromDataWindow();if(t.length>0)return t;const n=this.extractFromVisualElements();if(n.length>0)return n;const e=this.interceptChartData();return e.length>0?e:[]}extractFromDataWindow(){const t=[],n=document.querySelectorAll('[class*="valuesWrapper"], [class*="dataWindow"]');for(const e of n){const n=e.textContent||"",a=n.match(/O[:\s]+([0-9.]+)/i),r=n.match(/H[:\s]+([0-9.]+)/i),i=n.match(/L[:\s]+([0-9.]+)/i),s=n.match(/C[:\s]+([0-9.]+)/i),o=n.match(/V[ol]*[:\s]+([0-9.,KMB]+)/i);a&&r&&i&&s&&t.push({timestamp:Date.now(),open:parseFloat(a[1]),high:parseFloat(r[1]),low:parseFloat(i[1]),close:parseFloat(s[1]),volume:this.parseVolume(o?.[1]||"0")})}return t}extractFromVisualElements(){return[]}interceptChartData(){try{const t=window,n=t.TradingView?.activeChart?.()?.data?.();n&&Array.isArray(n)}catch{}return[]}parseVolume(t){const n=t.replace(/,/g,"").toUpperCase(),e={K:1e3,M:1e6,B:1e9},a=n.match(/([0-9.]+)([KMB])?/);return a?parseFloat(a[1])*(e[a[2]]||1):parseFloat(n)||0}extractIndicators(){const t=[],n=this.extractIndicatorValue("RSI","momentum");n&&t.push(n);const e=this.extractIndicatorValue("MACD","trend");e&&t.push(e);const a=this.extractIndicatorValue("EMA","trend");a&&t.push(a);const r=this.extractIndicatorValue("SMA","trend");return r&&t.push(r),t}extractIndicatorValue(t,n){const e=document.querySelectorAll('[class*="pane-legend"], [class*="studyLegend"]');for(const a of e){const e=a.textContent||"";if(e.includes(t)){const a=e.match(/[-0-9.]+/g)?.map(Number).filter(t=>!isNaN(t))||[];if(a.length>0)return{name:t,type:n,values:a}}}return null}}class e{constructor(){this.container=null,this.insightPanel=null,this.trendArrow=null,this.createContainer()}createContainer(){this.container=document.createElement("div"),this.container.id="ai-copilot-overlay",this.container.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 9999;\n    ",document.body.appendChild(this.container)}render(t,n){this.container&&(this.renderTrendArrow(t.prediction),(n.showConfidence||n.showExplanation)&&this.renderInsightPanel(t,n))}hide(){this.trendArrow&&(this.trendArrow.remove(),this.trendArrow=null),this.insightPanel&&(this.insightPanel.remove(),this.insightPanel=null)}renderTrendArrow(t){this.trendArrow&&this.trendArrow.remove();const n=this.findChartArea();if(!n)return;this.trendArrow=document.createElement("div"),this.trendArrow.className="ai-copilot-trend-arrow";const e=this.getArrowConfig(t.direction),a=this.getConfidenceColor(t.confidence);this.trendArrow.innerHTML=`\n      <div class="arrow-container" style="\n        position: fixed;\n        top: ${n.top+60}px;\n        right: ${window.innerWidth-n.right+20}px;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        pointer-events: auto;\n        cursor: pointer;\n        padding: 8px 12px;\n        background: rgba(20, 20, 30, 0.9);\n        border-radius: 8px;\n        border: 1px solid ${a};\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n        backdrop-filter: blur(8px);\n        transition: transform 0.2s ease;\n      ">\n        <div style="\n          font-size: 28px;\n          color: ${e.color};\n          text-shadow: 0 0 10px ${e.color};\n        ">${e.symbol}</div>\n        <div style="\n          font-size: 11px;\n          color: #a0a0a0;\n          margin-top: 4px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        ">${e.label}</div>\n        <div style="\n          font-size: 13px;\n          font-weight: 600;\n          color: ${a};\n          margin-top: 2px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        ">${t.confidence}%</div>\n      </div>\n    `,this.trendArrow.querySelector(".arrow-container")?.addEventListener("mouseenter",()=>{const t=this.trendArrow?.querySelector(".arrow-container");t&&(t.style.transform="scale(1.05)")}),this.trendArrow.querySelector(".arrow-container")?.addEventListener("mouseleave",()=>{const t=this.trendArrow?.querySelector(".arrow-container");t&&(t.style.transform="scale(1)")}),this.container?.appendChild(this.trendArrow)}renderInsightPanel(t,n){this.insightPanel&&this.insightPanel.remove();const e=this.findChartArea();if(!e)return;this.insightPanel=document.createElement("div"),this.insightPanel.className="ai-copilot-insight-panel";const a=this.getRiskConfig(t.riskLevel);this.insightPanel.innerHTML=`\n      <div class="insight-container" style="\n        position: fixed;\n        top: ${e.top+140}px;\n        right: ${window.innerWidth-e.right+20}px;\n        width: 280px;\n        pointer-events: auto;\n        background: rgba(20, 20, 30, 0.95);\n        border-radius: 12px;\n        border: 1px solid rgba(100, 100, 120, 0.3);\n        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);\n        backdrop-filter: blur(12px);\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n        overflow: hidden;\n      ">\n        <div style="\n          padding: 12px 16px;\n          background: linear-gradient(135deg, rgba(60, 60, 80, 0.5), rgba(40, 40, 60, 0.5));\n          border-bottom: 1px solid rgba(100, 100, 120, 0.2);\n          display: flex;\n          align-items: center;\n          justify-content: space-between;\n        ">\n          <span style="font-size: 13px; font-weight: 600; color: #ffffff;">\n            ü§ñ AI Insight\n          </span>\n          <span style="\n            font-size: 11px;\n            padding: 3px 8px;\n            border-radius: 4px;\n            background: ${a.bg};\n            color: ${a.color};\n          ">\n            ${a.label} Risk\n          </span>\n        </div>\n        \n        <div style="padding: 16px;">\n          ${n.showConfidence?this.renderProbabilities(t.prediction):""}\n          \n          ${n.showExplanation?`\n            <div style="\n              margin-top: 12px;\n              padding: 12px;\n              background: rgba(40, 40, 60, 0.5);\n              border-radius: 8px;\n              font-size: 12px;\n              line-height: 1.5;\n              color: #c0c0c0;\n            ">\n              ${t.explanation}\n            </div>\n          `:""}\n          \n          ${t.warnings.length>0?`\n            <div style="\n              margin-top: 12px;\n              padding: 10px;\n              background: rgba(255, 180, 50, 0.1);\n              border: 1px solid rgba(255, 180, 50, 0.3);\n              border-radius: 8px;\n              font-size: 11px;\n              color: #ffb432;\n            ">\n              ‚ö†Ô∏è ${t.warnings.join(" ")}\n            </div>\n          `:""}\n        </div>\n        \n        <div style="\n          padding: 8px 16px;\n          font-size: 10px;\n          color: #606060;\n          text-align: center;\n          border-top: 1px solid rgba(100, 100, 120, 0.2);\n        ">\n          Not financial advice ‚Ä¢ For educational purposes only\n        </div>\n      </div>\n    `,this.container?.appendChild(this.insightPanel)}renderProbabilities(t){return`\n      <div style="display: flex; flex-direction: column; gap: 8px;">\n        ${[{label:"Bullish",value:t.probabilities.bullish,color:"#22c55e"},{label:"Bearish",value:t.probabilities.bearish,color:"#ef4444"},{label:"Neutral",value:t.probabilities.neutral,color:"#a0a0a0"}].map(t=>`\n          <div style="display: flex; align-items: center; gap: 8px;">\n            <span style="font-size: 11px; color: #808080; width: 50px;">${t.label}</span>\n            <div style="\n              flex: 1;\n              height: 6px;\n              background: rgba(60, 60, 80, 0.5);\n              border-radius: 3px;\n              overflow: hidden;\n            ">\n              <div style="\n                width: ${t.value}%;\n                height: 100%;\n                background: ${t.color};\n                border-radius: 3px;\n                transition: width 0.3s ease;\n              "></div>\n            </div>\n            <span style="\n              font-size: 11px;\n              font-weight: 600;\n              color: ${t.color};\n              width: 35px;\n              text-align: right;\n            ">${t.value}%</span>\n          </div>\n        `).join("")}\n      </div>\n    `}findChartArea(){const t=[".chart-container",'[class*="chart-markup-table"]',".tv-chart-container","canvas"];for(const n of t){const t=document.querySelector(n);if(t)return t.getBoundingClientRect()}return null}getArrowConfig(t){return{bullish:{symbol:"‚Üë",color:"#22c55e",label:"BULLISH"},bearish:{symbol:"‚Üì",color:"#ef4444",label:"BEARISH"},neutral:{symbol:"‚Üí",color:"#a0a0a0",label:"NEUTRAL"}}[t]}getConfidenceColor(t){return t>=70?"#22c55e":t>=50?"#f59e0b":"#ef4444"}getRiskConfig(t){return{low:{bg:"rgba(34, 197, 94, 0.2)",color:"#22c55e",label:"Low"},medium:{bg:"rgba(245, 158, 11, 0.2)",color:"#f59e0b",label:"Medium"},high:{bg:"rgba(239, 68, 68, 0.2)",color:"#ef4444",label:"High"}}[t]}}const a={apiEndpoint:"http://localhost:8000",autoAnalyze:!0,overlayEnabled:!0,showConfidence:!0,showExplanation:!0,analysisInterval:60};class r{constructor(){this.settings=a,this.analysisInterval=null,this.isAnalyzing=!1,this.screenAnalyzer=new t,this.domParser=new n,this.overlayRenderer=new e,this.init()}async init(){console.log("[AI Trading Co-Pilot] Content script loaded on TradingView"),await this.waitForChart(),await this.loadSettings(),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),this.settings.autoAnalyze&&this.startAutoAnalysis(),this.triggerAnalysis()}async waitForChart(){return new Promise(t=>{const n=()=>{document.querySelector('.chart-container, [class*="chart-markup-table"]')?t():setTimeout(n,500)};n()})}async loadSettings(){try{const t=await chrome.runtime.sendMessage({type:"GET_STATUS",payload:null,timestamp:Date.now()});t?.settings&&(this.settings=t.settings)}catch(t){console.warn("[AI Trading Co-Pilot] Could not load settings:",t)}}handleMessage(t,n,e){switch(t.type){case"PREDICTION_RESULT":return this.displayInsight(t.payload),e({received:!0}),!1;case"SETTINGS_UPDATE":return this.settings={...this.settings,...t.payload},this.handleSettingsChange(),e({success:!0}),!1;default:return!1}}handleSettingsChange(){this.settings.autoAnalyze?this.startAutoAnalysis():this.stopAutoAnalysis(),this.settings.overlayEnabled||this.overlayRenderer.hide()}startAutoAnalysis(){this.analysisInterval||(this.analysisInterval=window.setInterval(()=>{this.triggerAnalysis()},1e3*this.settings.analysisInterval))}stopAutoAnalysis(){this.analysisInterval&&(clearInterval(this.analysisInterval),this.analysisInterval=null)}async triggerAnalysis(){if(!this.isAnalyzing){this.isAnalyzing=!0;try{const t=await this.extractChartData();if(0===t.candles.length)return void console.warn("[AI Trading Co-Pilot] No candle data found");const n={type:"ANALYZE_CHART",payload:t,timestamp:Date.now()};await chrome.runtime.sendMessage(n)}catch(t){console.error("[AI Trading Co-Pilot] Analysis error:",t)}finally{this.isAnalyzing=!1}}}async extractChartData(){const t=this.domParser.parseChart(),n=await this.screenAnalyzer.analyzeChart();return{symbol:t.symbol||n.symbol||"UNKNOWN",timeframe:t.timeframe||n.timeframe||"1D",candles:t.candles.length>0?t.candles:n.candles,indicators:[...t.indicators,...n.indicators]}}displayInsight(t){this.settings.overlayEnabled&&this.overlayRenderer.render(t,{showConfidence:this.settings.showConfidence,showExplanation:this.settings.showExplanation})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>new r):new r})();